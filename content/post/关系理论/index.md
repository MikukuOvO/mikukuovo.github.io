---
title: 📦 关系理论
summary: 数据库系统关系理论部分的知识梳理，参考书为《Database Systems The Complete Book》
date: 2023-10-12
tags:
  - Database
---
## 键

### （候选）键

一个属性组，通过这个可以推出所有的属性，并且该属性的任意子集都不能再推出所有属性了。

候选键可能有若干多个。

### 超键

能推出所有属性组的集合，候选键是超键的子集，是极小的超键。

### 主键

当有若干个候选键的时候，挑出一个作为主键。

### 主属性

包含在任意一个候选键中的属性，通俗说就是候选键所有属性的并集。

### 非主属性

不包含在任意一个候选键中的属性。

### 外键

子数据表中出现了父数据表的主键，称为子数据表的外键。

## 范式

范式是层层包括的，即满足 $\text{2NF}$ 一定满足 $\text{1NF}$，满足 $\text{BCNF}$ 一定满足 $\text{3NF}$。

### 1NF

所有属性都是不可分割的数据项，即同一个属性不能有多个值或者有重复的属性。

### 2NF

不包含非主属性对候选键的部分函数依赖，即每个非主属性都完全依赖于任何一个候选键。

### 3NF

不存在非主属性对候选键的传递函数依赖。

### BCNF

不存在任何属性对候选键的部分函数依赖和传递函数依赖，即函数依赖集中函数依赖的左边都能包含候选键。

### 4NF

不存在左侧不是超键的多值依赖。

## 函数依赖集闭包

函数依赖集 $F$ 的闭包包括如下内容：

1. $F$
2. $F$ 能推出的非平凡的函数依赖
3. **平凡的函数依赖**

## 候选键的计算

将所有属性分为四类：

1. 只在函数依赖关系左边出现的属性，一定包含在候选键中。
2. 只在函数依赖关系右边出现的属性，一定**不**包含在候选键中。
3. 同时在左右两边出现的属性，可能包含在候选键中。
4. 都没出现的属性，一定包含在候选键中。

通过上述结论优化过程，分别计算关系 $R$ 的属性集合子集的闭包，如果闭包等于全集，那么该子集就是一个候选键。

候选键可能有若干个。

## 属性闭包计算

### 描述

输入属性集合 $\{A_1,A_2,...,A_n\}$，$FD$ 的集合 $S$，输出闭包 $\{A_1,A_2,...,A_n\}^+$。

### 过程

1. 分解 $S$ 中的 $FD$，使每个 $FD$ 的右边只有一个属性。
2. 设 $X$ 为我们所求的闭包，初始化为 $\{A_1,A_2,...,A_n\}$。
3. 反复寻找 $FD$，满足左侧的属性全部包含在 $X$ 中，而右侧的存在不包含在 $X$ 中的属性，将其加入 $X$ 中，重复该过程。
4. 当不能加入任何属性时，集合 $X$ 就是 $\{A_1,A_2,...,A_n\}^{+}$。

## 最小函数依赖集计算

### 描述

输入属性集合 $\{A_1,A_2,...,A_n\}$，$FD$ 的集合 $S$，输出其最小依赖集 $G$，满足 $G$ 与 $S$ 等价。

### 过程

1. 分解 $S$ 中的 $FD$，使每个 $FD$ 的右边只有一个属性。
2. 设 $X$ 为我们所求的最小依赖集，初始化为 $S$。
3. 去除函数依赖左边多余的属性，对于 $X$ 中的函数依赖关系 $A_iA_j...\rightarrow A_k$，在依赖集 $X$ 的基础上求出 $A_i^+$，如果满足 $A_k \subseteq A_i^+$，那么 $A_j$ 为多余的。
4. 去除多余的函数依赖，对于 $X$ 中的函数依赖关系 $A_i\rightarrow A_k$，在依赖集 $X-\{A_i\rightarrow A_k\}$ 的基础上求 $A_i^+$，如果满足 $A_k\subseteq A_i^+$，那么 $A_i\rightarrow A_k$ 为多余的。

## 函数依赖集的投影

### 描述

输入关系 $R$ 和通过投影 $R_1=\pi_L(R)$ 计算得到的关系 $R_1$，以及在 $R$ 中成立的 $FD$ 集合 $S$，输出在 $R_1$ 中成立 $FD$ 集合 $T$。

### 过程

1. 设 $X$ 为我们所求的 $FD$ 集合，初始化为空集。
2. 对于 $R_1$ 属性集合的每一个子集 $V$，分别在依赖集 $S$ 的基础上计算 $V^+$，对于所有在 $V^+$ 中并且属于 $R_1$ 集合中的属性 $A$，将 $V\rightarrow A$ 添加到 $X$ 中。
3. 现在得到的 $X$ 为在 $R_1$ 中成立的基本集，通过计算最小函数依赖集的方式得到所要求的 $T$。

### 例题

假设 $R(A,B,C,D,E)$ 中有 $\text{FD}:AB\rightarrow DE,C\rightarrow E,D\rightarrow C,E\rightarrow A$，将 $R$ 投影到关系 $S(A,B,C)$ 上。

我们计算 $A,B,C$ 子集的闭包：
$$
\{A\}^+=A \\ \{B\}^+=B \\ \{C\}^+=ACE \\ \{AB\}^+=ABCDE \\ \{AC\}^+=ACE \\ \{BC\}^+=ABCDE \\ 
$$
根据 $\{C\}^+$ 可以推出 $C\rightarrow A$，根据 $\{AB\}^+$ 可以推出 $AB\rightarrow C$，由于已经存在 $C\rightarrow A$，所以由 $\{BC\}^+$ 推出的 $BC\rightarrow A$ 可以被简化。

所以投影后的关系模式为 $AB\rightarrow C,C\rightarrow A$。

## BCNF 判断

关系模式 $R$ 属于 $\text{BCNF}$ 当且仅当每个非平凡依赖关系的左边必须是关系模式 $R$ 的超键。

## BCNF 分解算法

### 描述

输入关系 $R_0$ 和在其上的函数依赖集 $S_0$，输出由 $R_0$ 分解得到的关系集合，其中每个关系都满足 $\text{BCNF}$ 范式。

### 过程

通过递归的方式求解，假设目前的关系和其函数依赖集为 $R,S$。

1. 判断目前是否满足 $\text{BCNF}$ 范式，如果满足则返回结果。
2. 如果存在不满足的函数依赖 $X\rightarrow Y$，计算 $X^+$，选择 $R_1=X^+$ 作为一个关系模式，$R_2$ （包括属性 $X$ 和所有没有出现在 $X^+$ 中的 $R$ 中的属性）作为另一个关系模式。
3. 计算函数依赖集的投影，得到 $R_1,R_2$ 的函数依赖集，记为 $S_1,S_2$，递归下去。

### 例题

将关系模式 $R(A,B,C,D)$ 分解为 $\text{BCNF}$ 范式，函数依赖为 $AB\rightarrow C,C\rightarrow D,D\rightarrow A$。

通过计算属性子集的闭包，我们可以得到其候选键为 $AB,BC,BD$，容易发现 $C\rightarrow D,D\rightarrow A$ 违反了 $\text{BCNF}$ 范式，采用 $C\rightarrow D$ 进行分解，得到的两个关系模式为 $R_1=\{C\}^+=ACD,R_2=BC$，我们进行投影，接着我们递归的求解 $R_1,R_2$，发现 $D\rightarrow A$ 仍然违反 $\text{BCNF}$ 范式，因此我们将 $ACD$ 分解为 $AD,CD$，再进行投影，所以我们最终分解得到的三个关系模式分别为 $R_1(BC),R_2(AD),R_3(CD)$。

## 无损连接的 chase 检验

### 描述

输入一个关系 $R$ 和其分解得到的若干关系 $R_1,R_2,...,R_n$，输出能否通过 $R_1,R_2,...,R_n$ 的自然连接来得到 $R$。

### 过程

1. 建立表格，行标题为分解得到的关系模式 $R_i$，列标题为 $R$ 中的属性 $A,B,C,...$。
2. 对于 $R_i$ 中出现的属性，表格里填 $a,b,c,...$，对于没有出现过的属性，表格里填 $a_i,b_i,c_i,...$。
3. 循环考虑每个 $FD$ 中的函数依赖 $X\rightarrow Y$，对于在 $X$ 列中相等的行分量，将其在 $Y$ 列中的相应行修改为相同内容（无下标优先级最高，如果均有下标则修改为下标最小的）。
4. 如果存在某一行均不存在下标，则表示满足无损连接，如果一次循环后没有进行任何修改，则退出循环。

### 例题

假设关系 $R(A,B,C,D)$ 被分解为三个关系，其属性集分别为 $S_1=\{A,D\}$，$S_2=\{A,C\}$，$S_3=\{B,C,D\}$，$FD:A\rightarrow B,B\rightarrow C,CD\rightarrow A$ 判断是否为无损连接。

|   A   |   B   |   C   |   D   |
| :---: | :---: | :---: | :---: |
|  $a$  | $b_1$ | $c_1$ |  $d$  |
|  $a$  | $b_2$ |  $c$  | $d_2$ |
| $a_3$ |  $b$  |  $c$  |  $d$  |

根据 $A\rightarrow B$，得到：

|   A   |   B   |   C   |   D   |
| :---: | :---: | :---: | :---: |
|  $a$  | $b_1$ | $c_1$ |  $d$  |
|  $a$  | $b_1$ |  $c$  | $d_2$ |
| $a_3$ |  $b$  |  $c$  |  $d$  |

根据 $B\rightarrow C$，得到：

|   A   |   B   |  C   |   D   |
| :---: | :---: | :--: | :---: |
|  $a$  | $b_1$ | $c$  |  $d$  |
|  $a$  | $b_1$ | $c$  | $d_2$ |
| $a_3$ |  $b$  | $c$  |  $d$  |

根据 $CD\rightarrow A$，得到：

|  A   |   B   |  C   |   D   |
| :--: | :---: | :--: | :---: |
| $a$  | $b_1$ | $c$  |  $d$  |
| $a$  | $b_1$ | $c$  | $d_2$ |
| $a$  |  $b$  | $c$  |  $d$  |

由于最后一行全部不含下标，所以得到其为无损连接。

## 第三范式判断

关系模式 $R$ 属于第三范式当且仅当每个非平凡依赖关系的左边必须是关系模式 $R$ 的超键或者右边仅由主属性构成。

## 第三范式分解算法

### 描述

输入关系 $R$ 和在其上的函数依赖集 $S$，输出由 $R$ 分解得到的关系集合，其中每个关系都满足第三范式，并且满足分解具有无损连接性。

### 过程

1. 求解 $S$ 的最小函数依赖集，记为 $G$。
2. 对于 $G$ 中的每一个函数依赖 $X\rightarrow A$，将 $XA$ 作为分解出的某个关系的属性集合。
3. 如果第二步分解出的关系模式的属性集合均不为 $R$ 的超键，那么就添加一个关系，其属性集合为 $R$ 的任意键。
4. 如果还要求函数依赖集，则计算函数依赖集的投影。

### 例题

设有关系 $R(A,B,C,D,E)$，$F=\{A\rightarrow D,E\rightarrow D,D\rightarrow B,BC\rightarrow D,DC\rightarrow A\}$，将 $R$ 分解为 $\text{3NF}$，并具有无损连接性。

通过计算子集的闭包可以求出候选键为 $CE$，应用最小依赖集算法可以发现 $F$ 已经满足最小依赖集，因此我们得到的分解关系模式为 $AD,DE,BD,BCD,ACD$，去除被包括的 $AD,BD$，剩余的为 $DE,BCD,ACD$，由于其中不包含候选键的超键，所以我们加入候选键 $CE$，答案为 $DE,BCD,ACD,CE$。